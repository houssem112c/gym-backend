// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "linux-musl", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String      @id @default(uuid())
  email        String      @unique
  password     String
  name         String
  role         Role        @default(USER)
  isActive     Boolean     @default(true)
  refreshToken String?     // Store refresh token for JWT
  
  // Profile fields
  avatar       String?     // Profile image URL from Supabase
  bio          String?     // User biography
  phone        String?     // Phone number
  dateOfBirth  DateTime?   // Date of birth
  address      String?     // Physical address
  city         String?     // City
  country      String?     // Country
  
  contacts       Contact[]   // User's contact messages
  bmiRecords     BmiRecord[] // User's BMI records
  progressPhotos UserProgressPhoto[]
  measurements   UserMeasurement[]
  prs            UserPR[]
  workoutSessions WorkoutSession[]
  feedPosts      FeedPost[]
  feedLikes      FeedLike[]
  feedComments   FeedComment[]
  notifications  Notification[]

  sentRequests     Friendship[] @relation("SentRequests")
  receivedRequests Friendship[] @relation("ReceivedRequests")

  
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@map("users")
}

enum Role {
  ADMIN
  USER
}

model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  color       String?  // Hex color for UI
  icon        String?  // Icon name for UI
  muscleGroup String?  // Muscle group target (chest, back, legs, etc.)
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  courses     Course[]
  stories     Story[]

  @@map("categories")
}

model Course {
  id          String            @id @default(uuid())
  title       String
  description String?
  duration    Int // duration in minutes
  capacity    Int // max participants
  instructor  String
  categoryId  String
  category    Category          @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  videoUrl    String? // Main course video URL
  thumbnail   String? // Course thumbnail
  isActive    Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  schedules   CourseSchedule[]

  @@map("courses")
}

model CourseSchedule {
  id           String        @id @default(uuid())
  courseId     String
  course       Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  // Session details
  title        String? // Optional session title
  coachName    String? // Coach/Instructor name
  
  // For one-time events
  specificDate DateTime?
  
  // For recurring events
  dayOfWeek    Int? // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
  startTime    String // Format: "HH:mm"
  endTime      String // Format: "HH:mm"
  
  // Recurring period
  startDate    DateTime? // Start of recurring period
  endDate      DateTime? // End of recurring period (null = indefinite)
  
  isRecurring  Boolean       @default(false)
  isActive     Boolean       @default(true)
  
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@map("course_schedules")
}

model Contact {
  id         String   @id @default(uuid())
  userId     String?  // Optional: authenticated user
  user       User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  name       String
  email      String
  phone      String?
  subject    String
  message    String
  isRead     Boolean  @default(false)
  
  // Admin response
  adminResponse String? // Admin's response to the message
  respondedAt   DateTime? // When admin responded
  respondedBy   String? // Admin user ID who responded
  
  // Message status
  status        ContactStatus @default(OPEN)
  priority      ContactPriority @default(NORMAL)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("contacts")
}

enum ContactStatus {
  OPEN
  IN_PROGRESS
  RESPONDED
  CLOSED
}

enum ContactPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model Location {
  id          String   @id @default(uuid())
  name        String // Gym location name
  description String? // Description of the location
  latitude    Float // Latitude coordinate
  longitude   Float // Longitude coordinate
  address     String? // Full address
  phone       String? // Contact phone
  email       String? // Contact email
  hours       String? // Opening hours
  isActive    Boolean  @default(true)
  order       Int      @default(0) // Display order
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("locations")
}

model BmiRecord {
  id           String        @id @default(uuid())
  userId       String
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  age          Int
  gender       Gender
  height       Float         // Height in meters
  weight       Float         // Weight in kilograms
  bmiValue     Float         // Calculated BMI value
  category     String        // BMI category (e.g., "Normal", "Overweight", etc.)
  status       BmiStatus     // Health status (OK, CAUTION, NOT_OK)
  notes        String?       // Additional notes or recommendations
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@map("bmi_records")
}

enum Gender {
  MALE
  FEMALE
}

enum BmiStatus {
  OK
  CAUTION
  NOT_OK
}

model Story {
  id          String   @id @default(uuid())
  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  mediaUrl    String   // Image or video URL
  mediaType   MediaType // IMAGE or VIDEO
  caption     String?
  duration    Int      @default(5) // Display duration in seconds (for images)
  expiresAt   DateTime? // Optional: auto-expire after X time
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("stories")
}

model Exercise {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  muscleGroup String?  // e.g., "Chest", "Back"
  equipment   String?  // e.g., "Dumbbell", "Barbell"
  videoUrl    String?  // Demonstration video
  imageUrl    String?  // Illustration image
  difficulty  Difficulty @default(BEGINNER)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workoutExercises WorkoutPlanExercise[]
  userPRs          UserPR[]
  setLogs          SetLog[]

  @@map("exercises")
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

model WorkoutPlan {
  id          String   @id @default(uuid())
  title       String
  description String?
  goal        String?  // e.g., "Strength", "Weight Loss"
  durationWeeks Int?   // Expected duration
  difficulty  Difficulty @default(BEGINNER)
  imageUrl    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  exercises   WorkoutPlanExercise[]
  workoutSessions WorkoutSession[]

  @@map("workout_plans")
}

model WorkoutPlanExercise {
  id            String      @id @default(uuid())
  workoutPlanId String
  workoutPlan   WorkoutPlan @relation(fields: [workoutPlanId], references: [id], onDelete: Cascade)
  exerciseId    String
  exercise      Exercise    @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  
  order         Int         @default(0)
  sets          Int?
  reps          String?     // e.g., "8-12" or "To Failure"
  notes         String?

  @@map("workout_plan_exercises")
}

model UserProgressPhoto {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  imageUrl    String   // URL from Supabase
  type        PhotoType @default(FRONT)
  notes       String?
  createdAt   DateTime @default(now())

  @@map("user_progress_photos")
}

enum PhotoType {
  FRONT
  BACK
  SIDE
}

model UserMeasurement {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  weight      Float?
  bodyFat     Float?
  waist       Float?
  chest       Float?
  arms        Float?
  legs        Float?
  createdAt   DateTime @default(now())

  @@map("user_measurements")
}

model UserPR {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exerciseId  String
  exercise    Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  weight      Float
  reps        Int
  notes       String?
  createdAt   DateTime @default(now())

  @@map("user_prs")
}

enum MediaType {
  IMAGE
  VIDEO
}

model WorkoutSession {
  id            String      @id @default(uuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  workoutPlanId String?
  workoutPlan   WorkoutPlan? @relation(fields: [workoutPlanId], references: [id], onDelete: SetNull)
  
  startTime     DateTime    @default(now())
  endTime       DateTime?
  status        SessionStatus @default(IN_PROGRESS)
  totalVolume   Float?      // Sum of weight * reps
  notes         String?

  setLogs       SetLog[]

  @@map("workout_sessions")
}

model SetLog {
  id               String         @id @default(uuid())
  workoutSessionId String
  workoutSession   WorkoutSession @relation(fields: [workoutSessionId], references: [id], onDelete: Cascade)
  exerciseId       String
  exercise         Exercise       @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  
  setNumber        Int
  weight           Float
  reps             Int
  isPersonalRecord Boolean        @default(false)
  
  createdAt        DateTime       @default(now())

  @@map("set_logs")
}

enum SessionStatus {
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model FeedPost {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  media       FeedMedia[]
  likes       FeedLike[]
  comments    FeedComment[]

  // Sharing logic
  sharedPostId String?
  sharedPost   FeedPost?  @relation("Shares", fields: [sharedPostId], references: [id])
  shares       FeedPost[] @relation("Shares")

  @@map("feed_posts")
}

model FeedMedia {
  id          String   @id @default(uuid())
  postId      String
  post        FeedPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  url         String
  mediaType   MediaType @default(IMAGE)
  order       Int      @default(0)
  createdAt   DateTime @default(now())

  @@map("feed_media")
}

model FeedLike {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  postId     String
  post       FeedPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([userId, postId])
  @@map("feed_likes")
}

model FeedComment {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  postId     String
  post       FeedPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  content    String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("feed_comments")
}

model Friendship {
  id          String           @id @default(uuid())
  requesterId String
  requester   User             @relation("SentRequests", fields: [requesterId], references: [id], onDelete: Cascade)
  addresseeId String
  addressee   User             @relation("ReceivedRequests", fields: [addresseeId], references: [id], onDelete: Cascade)
  status      FriendshipStatus @default(PENDING)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@unique([requesterId, addresseeId])
  @@map("friendships")
}

enum FriendshipStatus {
  PENDING
  ACCEPTED
  DECLINED
}

model Notification {
  id          String           @id @default(uuid())
  userId      String
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        NotificationType
  actorId     String           // User who triggered it
  referenceId String?          // ID of post, story, or friendship
  title       String
  message     String
  isRead      Boolean          @default(false)
  createdAt   DateTime         @default(now())

  @@map("notifications")
}

enum NotificationType {
  POST_CREATED
  STORY_CREATED
  FRIEND_REQUEST
  FRIEND_ACCEPTED
}
